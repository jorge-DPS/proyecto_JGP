!function(){"use strict";function l(t){var e=t;return{get:function(){return e},set:function(t){e=t}}}function m(t){return!(null===t||void 0===t)}var t,e,n,r=tinymce.util.Tools.resolve("tinymce.PluginManager"),f=tinymce.util.Tools.resolve("tinymce.util.Tools"),i=function(t){return function(){return t}},u=i(!1),a=i(!0),o=function(){return c},c=(t=function(t){return t.isNone()},{fold:function(t,e){return t()},is:u,isSome:u,isNone:a,getOr:n=function(t){return t},getOrThunk:e=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:i(null),getOrUndefined:i(void 0),or:n,orThunk:e,map:o,each:function(){},bind:o,exists:u,forall:a,filter:o,equals:t,equals_:t,toArray:function(){return[]},toString:i("none()")}),s=function(n){function t(){return o}function e(t){return t(n)}var r=i(n),o={fold:function(t,e){return e(n)},is:function(t){return n===t},isSome:a,isNone:u,getOr:r,getOrThunk:r,getOrDie:r,getOrNull:r,getOrUndefined:r,or:t,orThunk:t,map:function(t){return s(t(n))},each:function(t){t(n)},bind:e,exists:e,forall:e,filter:function(t){return t(n)?o:c},toArray:function(){return[n]},toString:function(){return"some("+n+")"},equals:function(t){return t.is(n)},equals_:function(t,e){return t.fold(u,function(t){return e(n,t)})}};return o},h={some:s,none:o,from:function(t){return null==t?c:s(t)}},d=function(t){return"function"==typeof t};function g(t,e){return y(document.createElement("canvas"),t,e)}function p(t){var e=g(t.width,t.height);return v(e).drawImage(t,0,0),e}function v(t){return t.getContext("2d")}function y(t,e,n){return t.width=e,t.height=n,t}var w,b,I,_=window.Promise||(w=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],E(t,R(U,this),R(A,this))},o=window,b=w.immediateFn||"function"==typeof o.setImmediate&&o.setImmediate||function(t){setTimeout(t,1)},I=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},w.prototype.catch=function(t){return this.then(null,t)},w.prototype.then=function(n,r){var o=this;return new w(function(t,e){T.call(o,new j(n,r,t,e))})},w.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var a=Array.prototype.slice.call(1===t.length&&I(t[0])?t[0]:t);return new w(function(o,i){if(0===a.length)return o([]);for(var u=a.length,t=0;t<a.length;t++)!function e(n,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if("function"==typeof r)return r.call(t,function(t){e(n,t)},i),0}a[n]=t,0==--u&&o(a)}catch(t){i(t)}}(t,a[t])})},w.resolve=function(e){return e&&"object"==typeof e&&e.constructor===w?e:new w(function(t){t(e)})},w.reject=function(n){return new w(function(t,e){e(n)})},w.race=function(o){return new w(function(t,e){for(var n=0,r=o;n<r.length;n++)r[n].then(t,e)})},w);function R(t,e){return function(){return t.apply(e,arguments)}}function T(n){var r=this;null!==this._state?b(function(){var t,e=r._state?n.onFulfilled:n.onRejected;if(null!==e){try{t=e(r._value)}catch(t){return void n.reject(t)}n.resolve(t)}else(r._state?n.resolve:n.reject)(r._value)}):this._deferreds.push(n)}function U(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void E(R(e,t),R(U,this),R(A,this))}this._state=!0,this._value=t,x.call(this)}catch(t){A.call(this,t)}}function A(t){this._state=!1,this._value=t,x.call(this)}function x(){for(var t=0,e=this._deferreds;t<e.length;t++){var n=e[t];T.call(this,n)}this._deferreds=[]}function j(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r}function E(t,e,n){var r=!1;try{t(function(t){r||(r=!0,e(t))},function(t){r||(r=!0,n(t))})}catch(t){if(r)return;r=!0,n(t)}}function k(a){return new _(function(t,e){var n=URL.createObjectURL(a),r=new Image,o=function(){r.removeEventListener("load",i),r.removeEventListener("error",u)};function i(){o(),t(r)}function u(){o(),e("Unable to load data of type "+a.type+": "+n)}r.addEventListener("load",i),r.addEventListener("error",u),r.src=n,r.complete&&i()})}function O(d){return new _(function(t,e){!function(){var t=d.split(","),e=/data:([^;]+)/.exec(t[0]);if(!e)return h.none();for(var e=e[1],t=t[1],n=atob(t),r=n.length,o=Math.ceil(r/1024),i=new Array(o),u=0;u<o;++u){for(var a=1024*u,c=Math.min(1024+a,r),s=new Array(c-a),l=a,f=0;l<c;++f,++l)s[f]=n[l].charCodeAt(0);i[u]=new Uint8Array(s)}return h.some(new Blob(i,{type:e}))}().fold(function(){e("uri is not base64: "+d)},t)})}function C(t,r,o){return r=r||"image/png",d(HTMLCanvasElement.prototype.toBlob)?new _(function(e,n){t.toBlob(function(t){t?e(t):n()},r,o)}):O(t.toDataURL(r,o))}function L(t,e){return function(t,e,n){for(var r=0,o=t.length;r<o;r++){var i=t[r];if(e(i,r))return h.some(i);if(n(i,r))break}return h.none()}(t,e,u)}var S=k,P=function(t){var r;return 0===(t=t.src).indexOf("data:")?O(t):(r=t,new _(function(t,e){var n=new XMLHttpRequest;n.open("GET",r,!0),n.responseType="blob",n.onload=function(){200===this.status&&t(this.response)},n.onerror=function(){var t;e(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+this.status+" downloading image"))},n.send()}))};function B(t,e,n){var r=e.type;function o(e,n){return t.then(function(t){return t.toDataURL(e||"image/png",n)})}return{getType:i(r),toBlob:function(){return _.resolve(e)},toDataURL:i(n),toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return C(t,e,n)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(p)}}}function M(e,t){return C(e,t).then(function(t){return B(_.resolve(e),t,e.toDataURL())})}function F(e,n,r){return void 0===r&&(r=!1),new _(function(t){var u=new XMLHttpRequest;u.onreadystatechange=function(){4===u.readyState&&t({status:u.status,blob:u.response})},u.open("GET",e,!0),u.withCredentials=r,function(t){for(var e,n=W(t),r=0,o=n.length;r<o;r++){var i=n[r];e=t[i],u.setRequestHeader(i,e)}}(n),u.responseType="blob",u.send()})}function N(t,e){var o,i,e=(o=function(t,e){return m(t)?t[e]:void 0},i=t,function(t){for(var e,n=0,r=t.length;n<r;n++)e=t[n],i=o(i,e)}(e),i);return h.from(e)}function D(t){var e,t=(e=t,"ImageProxy HTTP error: "+L(X,function(t){return e===t.code}).fold(i("Unknown ImageProxy error"),function(t){return t.message}));return _.reject(t)}function q(e){return L(Q,function(t){return t.type===e}).fold(i("Unknown service error"),function(t){return t.message})}function H(t){return r=t,new _(function(t,e){var n=new FileReader;n.onload=function(){t(n.result)},n.onerror=function(t){e(t)},n.readAsText(r)}).then(function(t){t="ImageProxy Service error: "+function(t){try{return h.some(JSON.parse(t))}catch(t){return h.none()}}(t).bind(function(t){return N(t,["error","type"]).map(q)}).getOr("Invalid JSON in service error message");return _.reject(t)});var r}function z(t){return t<200||300<=t}function $(t,e,n){return void 0===n&&(n=!1),e?(i={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":r=e},F((o=r,e=-1===(r=e=t).indexOf("?")?"?":"&",/[?&]apiKey=/.test(r)?r:r+e+"apiKey="+encodeURIComponent(o)),i).then(function(t){return z(t.status)?(e=t.status,"application/json"!==(null==(n=t.blob)?void 0:n.type)||400!==e&&403!==e&&404!==e&&500!==e?D(e):H(n)):_.resolve(t.blob);var e,n})):F(t,{},n).then(function(t){return z(t.status)?D(t.status):_.resolve(t.blob)});var r,o,i}function G(t){if(null==t)throw new Error("Node cannot be null or undefined");return{dom:t}}function J(t){return t.getParam("imagetools_proxy")}var K=function(i,u){return i.toCanvas().then(function(t){return e=t,n=i.getType(),r=u,o=g(e.width,e.height),t=v(o),"v"===r?(t.scale(1,-1),t.drawImage(e,0,-o.height)):(t.scale(-1,1),t.drawImage(e,-o.width,0)),M(o,n);var e,n,r,o})},V=function(a,c){return a.toCanvas().then(function(t){return e=t,n=a.getType(),r=c,o=g(e.width,e.height),i=v(o),90!==(r=r<(t=u=0)?360+r:r)&&270!==r||y(o,o.height,o.width),90!==r&&180!==r||(u=o.width),270!==r&&180!==r||(t=o.height),i.translate(u,t),i.rotate(r*Math.PI/180),i.drawImage(e,0,0),M(o,n);var e,n,r,o,i,u})},W=Object.keys,X=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],Q=[{type:"not_found",message:"Failed to load image."},{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],Y=function(e){return n=e,new _(function(t){var e=new FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(n)}).then(function(t){return B(k(e).then(function(t){URL.revokeObjectURL(t.src);var e=g(t.naturalWidth||t.width,t.naturalHeight||t.height);return v(e).drawImage(t,0,0),e}),e,t)});var n},Z=G,tt=("undefined"!=typeof window||Function("return this;")(),function(t,e){return n=function(n){return function(t){var e=n.dom;if(1!==e.nodeType)return!1;if(void 0!==e.matches)return e.matches(t);if(void 0!==e.msMatchesSelector)return e.msMatchesSelector(t);if(void 0!==e.webkitMatchesSelector)return e.webkitMatchesSelector(t);if(void 0!==e.mozMatchesSelector)return e.mozMatchesSelector(t);throw new Error("Browser lacks native selectors")}(e)},L(t.dom.childNodes,function(t){return n(Z(t))}).map(Z);var n}),et=tinymce.util.Tools.resolve("tinymce.util.Delay"),nt=tinymce.util.Tools.resolve("tinymce.util.Promise"),rt=tinymce.util.Tools.resolve("tinymce.util.URI");function ot(t){var e,n;function r(t){return/^[0-9\.]+px$/.test(t)}return e=t.style.width,n=t.style.height,e||n?r(e)&&r(n)?{w:parseInt(e,10),h:parseInt(n,10)}:null:(e=t.width,n=t.height,e&&n?{w:parseInt(e,10),h:parseInt(n,10)}:null)}function it(t){return{w:t.naturalWidth,h:t.naturalHeight}}function ut(t){return tt(Z(t),"img")}function at(t,e){return t.dom.is(e,"figure")}function ct(t,e){return t.dom.is(e,"img:not([data-mce-object],[data-mce-placeholder])")}function st(e,t){function n(t){return ct(e,t)&&(_t(e,t)||Rt(e,t)||m(J(e)))}return at(e,t)?ut(t).bind(function(t){return n(t.dom)?h.some(t.dom):h.none()}):n(t)?h.some(t):h.none()}function lt(t,e){t.notificationManager.open({text:e,type:"error"})}function ft(t){var e=t.selection.getNode(),n=t.dom.getParent(e,"figure.image");return null!==n&&at(t,n)?ut(n):ct(t,e)?h.some(Z(e)):h.none()}function dt(t,e,n){return e=e.match(/(?:\/|^)(([^\/\?]+)\.(?:[a-z0-9.]+))(?:\?|$)/i),m(e)?t.dom.encode(e[n]):null}function ht(t,e){return h.from(t.getParam("imagetools_fetch_image",null,"function")).fold(function(){return function(t,e){if(Rt(t,e))return $(e.src,null,(n=e,-1!==f.inArray(t.getParam("imagetools_credentials_hosts",[],"string[]"),new rt(n.src).host)));if(_t(t,e))return P(e);var n=J(t),e=n+(-1===n.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),t=t.getParam("api_key",t.getParam("imagetools_api_key","","string"),"string");return $(e,t,!1)}(t,e)},function(t){return t(e)})}function mt(t,e){var n=t.editorUpload.blobCache.getByUri(e.src);return n?nt.resolve(n.blob()):ht(t,e)}function gt(t){et.clearTimeout(t.get())}function pt(a,c,s,l,f,d,h){return s.toBlob().then(function(t){var e,n,r,o=a.editorUpload.blobCache,i=d.src,u=c.type===t.type;return a.getParam("images_reuse_filename",!1,"boolean")&&(r=o.getByUri(i),n=m(r)?(i=r.uri(),e=r.name(),r.filename()):(e=dt(a,i,2),dt(a,i,1))),r=o.create({id:"imagetools"+It++,blob:t,base64:s.toBase64(),uri:i,name:e,filename:u?n:void 0}),o.add(r),a.undoManager.transact(function(){a.$(d).on("load",function t(){var e,n,r;a.$(d).off("load",t),a.nodeChanged(),l?a.editorUpload.uploadImagesAuto():(gt(f),e=a,n=f,r=et.setEditorTimeout(e,function(){e.editorUpload.uploadImagesAuto()},e.getParam("images_upload_timeout",3e4,"number")),n.set(r))}),h&&a.$(d).attr({width:h.w,height:h.h}),a.$(d).attr({src:r.blobUri()}).removeAttr("data-mce-src")}),r})}function vt(r,o,t,i){return function(){return ft(r).fold(function(){lt(r,"Could not find selected image")},function(n){return r._scanForImages().then(function(){return mt(r,n.dom)}).then(function(e){return Y(e).then(t).then(function(t){return pt(r,e,t,!1,o,n.dom,i)})}).catch(function(t){lt(r,t)})})}}function yt(e,n,r){return function(){var t=ft(e).fold(function(){return null},function(t){t=ot(t.dom);return t?{w:t.h,h:t.w}:null});return vt(e,n,function(t){return V(t,r)},t)()}}function wt(t,e,n){return function(){return vt(t,e,function(t){return K(t,n)})()}}function bt(c,s){return function(){var n=ft(c),i=n.map(function(t){return it(t.dom)});n.each(function(e){st(c,e.dom).each(function(t){mt(c,e.dom).then(function(t){t={blob:t,url:URL.createObjectURL(t)};c.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:t}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(t){var o=t.getData().imagetools.blob;n.each(function(r){i.each(function(t){var e,n,i,u,a;e=c,n=s,i=r.dom,u=t,S(a=o).then(function(t){var e,n,r,o=it(t);return u.w===o.w&&u.h===o.h||ot(i)&&(e=i,(n=o)&&(r=e.style.width,o=e.style.height,(r||o)&&(e.style.width=n.w+"px",e.style.height=n.h+"px",e.removeAttribute("data-mce-style")),r=e.width,o=e.height,(r||o)&&(e.setAttribute("width",String(n.w)),e.setAttribute("height",String(n.h))))),URL.revokeObjectURL(t.src),a}).then(Y).then(function(t){return pt(e,a,t,!0,n,i)}).catch(function(){})})}),t.close()},onCancel:function(){},onAction:function(t,e){switch(e.name){case"save-state":e.value?t.enable("save"):t.disable("save");break;case"disable":t.disable("save"),t.disable("cancel");break;case"enable":t.enable("cancel")}}})})})})}}var It=0,_t=function(t,e){e=e.src;return 0===e.indexOf("data:")||0===e.indexOf("blob:")||new rt(e).host===t.documentBaseURI.host},Rt=function(t,e){return-1!==f.inArray(t.getParam("imagetools_cors_hosts",[],"string[]"),new rt(e.src).host)};r.add("imagetools",function(t){var n,e,r,o,i,u,a=l(0),c=l(null),s=t;f.each({mceImageRotateLeft:yt(s,a,-90),mceImageRotateRight:yt(s,a,90),mceImageFlipVertical:wt(s,a,"v"),mceImageFlipHorizontal:wt(s,a,"h"),mceEditImage:bt(s,a)},function(t,e){s.addCommand(e,t)}),e=function(t){return function(){return n.execCommand(t)}},(n=t).ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:e("mceImageRotateLeft")}),n.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:e("mceImageRotateRight")}),n.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:e("mceImageFlipVertical")}),n.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:e("mceImageFlipHorizontal")}),n.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:e("mceEditImage"),onSetup:function(e){function t(){var t=ft(n).forall(function(t){return st(n,t.dom).isNone()});e.setDisabled(t)}return n.on("NodeChange",t),function(){n.off("NodeChange",t)}}}),n.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image",onAction:e("mceImage")}),n.ui.registry.addContextMenu("imagetools",{update:function(t){return st(n,t).fold(function(){return[]},function(t){return[{text:"Edit image",icon:"edit-image",onAction:e("mceEditImage")}]})}}),(r=t).ui.registry.addContextToolbar("imagetools",{items:r.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions"),predicate:function(t){return st(r,t).isSome()},position:"node",scope:"node"}),i=a,u=c,(o=t).on("NodeChange",function(t){var e=u.get(),t=st(o,t.element);e&&!t.exists(function(t){return e.src===t.src})&&(gt(i),o.editorUpload.uploadImagesAuto(),u.set(null)),t.each(u.set)})})}();